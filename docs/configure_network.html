<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" framework, model, tensorflow, caffe">
<title>Configuring Your Network for the Intel® Movidius™ Neural Compute SDK | Intel® Movidius™ Neural Compute SDK Documentation</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Configuring Your Network for the Intel® Movidius™ Neural Compute SDK</title>
<meta name="generator" content="Jekyll v3.8.1" />
<meta property="og:title" content="Configuring Your Network for the Intel® Movidius™ Neural Compute SDK" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documentation for the Intel® Movidius™ Neural Compute SDK and Intel® Movidius™ Neural Compute API." />
<meta property="og:description" content="Documentation for the Intel® Movidius™ Neural Compute SDK and Intel® Movidius™ Neural Compute API." />
<link rel="canonical" href="https://movidius.github.io/ncsdk/configure_network.html" />
<meta property="og:url" content="https://movidius.github.io/ncsdk/configure_network.html" />
<script type="application/ld+json">
{"description":"Documentation for the Intel® Movidius™ Neural Compute SDK and Intel® Movidius™ Neural Compute API.","@type":"WebPage","url":"https://movidius.github.io/ncsdk/configure_network.html","headline":"Configuring Your Network for the Intel® Movidius™ Neural Compute SDK","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });
        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Intel® Movidius™ Neural Compute SDK</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button 
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
		-->
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://developer.movidius.com/repo" target="_blank">GitHub</a></li>
                
                
                
                <li><a href="https://developer.movidius.com/blog" target="_blank">Blog</a></li>
                
                
                
                <li><a href="https://developer.movidius.com/forums" target="_blank">User Forum</a></li>
                
                
                
                <li><a href="https://developer.movidius.com/examples" target="_blank">NC App Zoo</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="https://movidius.github.io/ncsdk{url}" title="">{display}</a></li>',
                    noResultsText: '',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">NCSDK Documentation </li>
    
    
    
    
    <li>
        <a href="#">Overview</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="ncs.html">Intel® Movidius™ Neural Compute Stick</a></li>
            
            
            
            
        </ul>
    </li>
    
    
    
    
    
    <li>
        <a href="#">Installation</a>
        <ul>
            
            
            
            <li><a href="install.html">Basic Installation</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Other Installation Options</a>
                <ul>
                    
                    
                    
                    <li><a href="docker.html">Docker</a></li>
                    
                    
                    
                    
                    
                    <li><a href="virtualenv.html">virtualenv</a></li>
                    
                    
                    
                    
                    
                    <li><a href="vm_config.html">Virtual Machine</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
    </li>
    
    
    
    
    
    <li>
        <a href="#">Frameworks</a>
        <ul>
            
            
            
            <li class="active"><a href="configure_network.html">Network Configuration</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Caffe</a>
                <ul>
                    
                    
                    
                    <li><a href="caffe.html">Overview</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            <li class="subfolders">
                <a href="#">TensorFlow™</a>
                <ul>
                    
                    
                    
                    <li><a href="tensorflow.html">Overview</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tf_compile_guidance.html">Compilation Guidance</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tf_slim.html">Compiling TensorFlow-Slim Networks</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tf_modelzoo.html">Compiling Model Zoo Networks</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
    </li>
    
    
    
    
    
    <li>
        <a href="#">Toolkit</a>
        <ul>
            
            
            
            <li><a href="tools/tools_overview.html">Toolkit Overview</a></li>
            
            
            
            
            
            
            <li><a href="tools/compile.html">mvNCCompile</a></li>
            
            
            
            
            
            
            <li><a href="tools/check.html">mvNCCheck</a></li>
            
            
            
            
            
            
            <li><a href="tools/profile.html">mvNCProfile</a></li>
            
            
            
            
        </ul>
    </li>
    
    
    
    
    
    <li>
        <a href="#">API</a>
        <ul>
            
            
            
            <li><a href="ncapi/readme.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">NCAPI v2</a>
                <ul>
                    
                    
                    
                    <li><a href="ncapi/ncapi2/py_api/readme.html">Python</a></li>
                    
                    
                    
                    
                    
                    <li><a href="ncapi/ncapi2/c_api/readme.html">C/C++</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            <li class="subfolders">
                <a href="#">NCAPI v1</a>
                <ul>
                    
                    
                    
                    <li><a href="ncapi/ncapi1/py_api/readme.html">Python</a></li>
                    
                    
                    
                    
                    
                    <li><a href="ncapi/ncapi1/c_api/readme.html">C/C++</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            <li class="subfolders">
                <a href="#">NCAPI v1 to NCAPI v2 Conversion</a>
                <ul>
                    
                    
                    
                    <li><a href="ncapi/python_api_migration.html">Python</a></li>
                    
                    
                    
                    
                    
                    <li><a href="ncapi/c_api_migration.html">C/C++</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
    </li>
    
    
    
    
    
    
    <li class="singlenav">
    
    <a href="examples.html">Examples</a>
    </li>
    
    
    
    
    
    
    <li class="singlenav">
    
    <a href="release_notes.html">Release Notes</a>
    </li>
    
    
    
    
    
    
    <li class="singlenav">
    
    <a href="support.html">Support</a>
    </li>
    
    
    
    
    <!-- if you aren't using the accordion, uncomment this block:
       <p class="external">
           <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
       </p>
       -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <h1 id="configuring-your-network-for-the-intel-movidius-neural-compute-sdk">Configuring Your Network for the Intel® Movidius™ Neural Compute SDK</h1>

<p>This guide will help you get all of the configuration information correct when creating your network for the Intel® Movidius™ Neural Compute SDK (NCSDK). All of these parameters are critical. If you don’t get them right, your network won’t give you the accuracy that was achieved by the team that trained the model. The configuration parameters are as follows:</p>
<ul>
  <li>Mean subtraction</li>
  <li>Scale</li>
  <li>Color channel configuration</li>
  <li>Class prediction</li>
  <li>Input image size</li>
</ul>

<p><strong>Let’s go through these one at a time.</strong></p>

<h2 id="mean-subtraction">Mean Subtraction</h2>
<p>Mean subtraction on the input data to a convolutional neural network (CNN) is a common technique. The mean is calculated on the data set. For example, the mean on Imagenet is calculated on a per channel basis to be:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>104, 117, 123
These numbers are in BGR orientation.
</code></pre></div></div>
<h4 id="caffe-specific-examples">Caffe Specific Examples</h4>
<p>This mean calculation can be calculated with a tool that comes with caffe (<a href="https://github.com/BVLC/caffe/blob/master/tools/compute_image_mean.cpp">compute_image_mean.cpp</a>). Caffe provides a script to do it, as well (<a href="https://github.com/BVLC/caffe/blob/master/examples/imagenet/make_imagenet_mean.sh">make_imagenet_mean.sh</a>).</p>

<hr />
<p>This will create an output file often called mean_binary.proto. You can see an example of this in the training prototxt file for AlexNet:</p>

<p><a href="https://github.com/BVLC/caffe/blob/master/models/bvlc_alexnet/train_val.prototxt">train_val.prototxt</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> transform_param {
    mirror: true
    crop_size: 227
    mean_file: "data/ilsvrc12/imagenet_mean.binaryproto"
  }
</code></pre></div></div>
<hr />
<p>In the GoogLeNet prototxt file, they have put in the values directly:</p>

<p><a href="https://github.com/BVLC/caffe/blob/master/models/bvlc_googlenet/train_val.prototxt">train_val.prototxt</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  transform_param {
    mirror: true
    crop_size: 224
    mean_value: 104
    mean_value: 117
    mean_value: 123
  }
</code></pre></div></div>
<hr />
<p>Some models don’t use mean subtraction. See the LeNet example below. There is no mean in the transform_param, but there is a scale that we’ll get to later:</p>

<p><a href="https://github.com/BVLC/caffe/blob/master/examples/mnist/lenet_train_test.prototxt">lenet_train_test.prototxt</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  transform_param {
    scale: 0.00390625
  }
</code></pre></div></div>
<h4 id="tensorflow-specific-examples">TensorFlow Specific Examples</h4>
<p>TensorFlow* documentation of mean is not as straightforward as Caffe. The TensorFlow Slim models for image classification are a great place to get high quality pre-trained models:</p>

<p><a href="https://github.com/tensorflow/models/tree/master/research/slim#pre-trained-models">slim models</a></p>

<p>The following file is the mean (and scale) for both Inception V3 and MobileNet V1:</p>

<p><a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/image_retraining/retrain.py#L872">retrain script</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input_mean = 128
</code></pre></div></div>
<p>In the case of the Inception V3 model, there is not a per color channel mean. The same mean is used for all channels. This mean should apply to all of the Inception and MobileNet models, but other models might be different.</p>

<p>For example, the VGG16 model had the weights converted from Caffe. If we look at the link to the VGG16 for Caffe page, we see the means are done like the other Caffe models:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://gist.github.com/ksimonyan/211839e770f7b538e2d8#description

The following BGR values should be subtracted: [103.939, 116.779, 123.68]
</code></pre></div></div>

<h2 id="scale">Scale</h2>
<p>Typical 8-bit per pixel per channel images will have a scale of 0-255. Many CNN networks use the native scale, but some don’t. As was seen in a snippet of the Caffe prototxt file, the <strong>transform_param</strong> would show whether there was a scale. In the example of LeNet for Caffe, you can see it has a scale pameter of <strong>0.00390625</strong>.</p>

<p><a href="https://github.com/BVLC/caffe/blob/master/examples/mnist/lenet_train_test.prototxt">lenet_train_test.prototxt</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  transform_param {
    scale: 0.00390625
  }
</code></pre></div></div>
<p>This may seem like a strange number, but it is actually just 1/256. The input 8-bit image is being scaled down to an image from 0-1 instead of 0-255.</p>

<hr />
<p>Regarding the example of TensorFlow for Inception V3, the <strong>input_mean</strong> the <strong>input_std</strong> are listed below. This is a scaling factor. You divide 255/128, and it’s about 2. In this case, the scale is two, but the mean subtraction is 128. In the end, the scale is actually -1 to 1.</p>

<p><a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/image_retraining/retrain.py#L872">retrain script</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input_mean = 128
input_std = 128
</code></pre></div></div>
<h2 id="color-channel-configuration">Color Channel Configuration</h2>
<p>Different models may be trained with different color channel orientations (either RGB or BGR). Typically, Caffe models seem to be trained with BGR, whereas the Slim TensorFlow models (at least Inception and MobileNet) are trained in RGB.</p>

<p>Once you figure out the color channel orientation for your model, you will need to know the way the image is loaded. For example, opencv will open images in BGR, but skimiage will open the image in RGB.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* skimage.io.imread will open the image in RGB
* cv2.imread will open the image in BGR
* Caffe trained models will probably be BGR
* TensorFlow trained models will probably be in RGB
</code></pre></div></div>
<h2 id="categories">Categories</h2>
<p>For models that are trained on the ImageNet database, some have 1000 output classes and some have 1001 output classes. The extra output class is a background class. The following list has the list of the 1000 classes not including the background:
<a href="https://github.com/HoldenCaulfieldRye/caffe/blob/master/data/ilsvrc12/synset_words.txt">synset_words.txt</a></p>

<p>Most Caffe trained models seem to follow the 1000 class convention, and TensorFlow trained models follow the 1001 class convention. For the TensorFlow models, an offset needs to be added. You can see this documented in the <a href="https://github.com/tensorflow/models/tree/master/research/slim#the-resnet-and-vgg-models-have-1000-classes-but-the-imagenet-dataset-has-1001">TensorFlow GitHub</a>.</p>

<h2 id="putting-it-all-together">Putting It All Together</h2>
<p>Now with all of these factors, let’s go through two examples.</p>

<h4 id="caffe-example">Caffe Example</h4>
<p>Let’s use the Berkeley Caffe GoogLeNet model as an example. The basic model parameters are:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scale: 0-255 (before mean subtraction)
Mean: based on mean_binary.proto file
Color channel configuration: BGR
output categories: 1000
input size: 224x224
labels_offset=0
</code></pre></div></div>
<p>Code snippet:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#Load the label files
labels_offset=0 # no background class offset
labels_file='./synset_words.txt'
labels=numpy.loadtxt(labels_file,str,delimiter='\t')
#Load blob
with open('./googlenet.blob', mode='rb') as f:
	blob = f.read()
graph = device.AllocateGraph(blob)
graph.SetGraphOption(mvnc.GraphOption.ITERATIONS, 1)
iterations = graph.GetGraphOption(mvnc.GraphOption.ITERATIONS)
img = cv2.imread('./dog.jpg') # using OpenCV for reading the image, it will be in BGR
img=cv2.resize(img,(224,224)) # resize to 224x224
img-=[104,117,124] # subtract mean
#Run, get the result and print results per the synset_words.txt
graph.LoadTensor(img.astype(numpy.float16), 'user object')
output, userobj = graph.GetResult()
order = output.argsort()[::-1][:6]
print('\n------- predictions --------')
for i in range(0,5):
	print ('prediction ' + str(i) + ' is ' + labels[order[i]-labels_offset])
</code></pre></div></div>

<h4 id="tensorflow-example">TensorFlow Example</h4>
<p>Let’s use the TensorFlow Slim Inception V3:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scale: -1 to 1 (after mean subtraction)
Mean: 128
Color channel configuration: RBG
output categories: 1001
input size: 299x299
labels_offset=1
</code></pre></div></div>
<p>Code snippet:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#Load the label files
labels_offset=1 # background class offset of 1
labels_file='./synset_words.txt'
labels=numpy.loadtxt(labels_file,str,delimiter='\t')
#Load blob
with open('./inceptionv3.blob', mode='rb') as f:
	blob = f.read()
graph = device.AllocateGraph(blob)
graph.SetGraphOption(mvnc.GraphOption.ITERATIONS, 1)
iterations = graph.GetGraphOption(mvnc.GraphOption.ITERATIONS)
#Import the image and do the proper scaling
img = cv2.imread('./dog.jpg').astype(numpy.float32) # using OpenCV for reading the image, it will be in BGR
img=cv2.resize(img,(299,299)) # resize to 299x299
img=cv2.cvtColor(img,cv2.COLOR_BGR2RGB) # need to convert to RBG
img-=[128,128,128] # subtract mean 
img /=128. # scale the image
#Run, get the result and print results per the synset_words.txt
graph.LoadTensor(img.astype(numpy.float16), 'user object')
output, userobj = graph.GetResult()
order = output.argsort()[::-1][:6]
print('\n------- predictions --------')
for i in range(0,5):
	print ('prediction ' + str(i) + ' is ' + labels[order[i]-labels_offset])
</code></pre></div></div>

<div class="bs-callout bs-callout-info">Feedback or comments? Let me know at darren.s.crews@intel.com.</div>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2018 Intel Corporation <br />
                    * Other names and brands may be claimed as the property of others.
                </div>
            </div>
</footer>

</html>
